<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Ubike æœ€è¿‘ç«™é»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h2>ğŸš² Ubikeï¼ˆé«˜é›„ï¼‰</h2>

  <button onclick="find('rent')">ğŸš² æ‰¾å¯å€Ÿè»Š</button>
  <button onclick="find('return')">ğŸ…¿ï¸ æ‰¾å¯é‚„è»Š</button>

  <pre id="out">è«‹é»ä¸Šæ–¹æŒ‰éˆ•</pre>

  <script>
    // â­â­â­ åªæ”¹é€™ä¸€è¡Œ â­â­â­
    const API_BASE = "https://ubike-proxy.onrender.com";

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function find(mode) {
      document.getElementById('out').textContent = 'ğŸ“ å®šä½ä¸­â€¦';

      const pos = await new Promise((ok, err) =>
        navigator.geolocation.getCurrentPosition(ok, err)
      );

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      document.getElementById('out').textContent = 'ğŸ” å–å¾— Ubike è³‡æ–™â€¦';

      const [stations, availability] = await Promise.all([
        fetch(API_BASE + '/bike/station').then(r => r.json()),
        fetch(API_BASE + '/bike/availability').then(r => r.json())
      ]);

      let best = null;
      let min = Infinity;

      availability.forEach(a => {
        if (mode === 'rent' && a.AvailableRentBikes === 0) return;
        if (mode === 'return' && a.AvailableReturnBikes === 0) return;

        const s = stations.find(st => st.StationUID === a.StationUID);
        if (!s) return;

        const d = haversine(
          lat, lon,
          s.StationPosition.PositionLat,
          s.StationPosition.PositionLon
        );

        if (d < min) {
          min = d;
          best = { s, a };
        }
      });

      if (!best) {
        document.getElementById('out').textContent = 'âŒ é™„è¿‘æ²’æœ‰ç¬¦åˆçš„ç«™é»';
        return;
      }

      document.getElementById('out').textContent =
        `ç«™é»ï¼š${best.s.StationName.Zh_tw}\n` +
        `è·é›¢ï¼šç´„ ${min.toFixed(0)} å…¬å°º\n` +
        `å¯å€Ÿè»Šï¼š${best.a.AvailableRentBikes}\n` +
        `å¯é‚„è»Šä½ï¼š${best.a.AvailableReturnBikes}`;
    }
  </script>
</body>
</html>
