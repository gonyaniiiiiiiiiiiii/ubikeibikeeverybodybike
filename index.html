<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœ€è¿‘ Ubikeï¼ˆé«˜é›„ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; }
    #map { height: 60vh; margin-top: 10px; }
    button { padding: 10px 16px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>ğŸš² æœ€è¿‘çš„ Ubikeï¼ˆé«˜é›„ï¼‰</h2>
  <button onclick="findNearestUbike()">ğŸ“ ä½¿ç”¨æ‰‹æ©Ÿå®šä½</button>
  <pre id="result"></pre>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Kaohsiung?$top=50&$format=JSON";
    let map;

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function findNearestUbike() {
      if (!navigator.geolocation) {
        alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        const res = await fetch(API_URL);
        const data = await res.json();

        let nearest = null;
        let minDist = Infinity;

        data.forEach(station => {
          if (station.AvailableRentBikes === 0) return; // åªæ‰¾æœ‰è»Šçš„
          const lat = station.StationLatitude;
          const lon = station.StationLongitude;
          const dist = haversine(userLat, userLon, lat, lon);
          if (dist < minDist) {
            minDist = dist;
            nearest = station;
          }
        });

        document.getElementById("result").textContent =
          `æœ€è¿‘ç«™é»ï¼š${nearest.StationName.Zh_tw}\n` +
          `è·é›¢ï¼šç´„ ${minDist.toFixed(0)} å…¬å°º\n` +
          `å¯å€Ÿè»Šï¼š${nearest.AvailableRentBikes}`;

        if (!map) {
          map = L.map('map').setView([userLat, userLon], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
          }).addTo(map);
        }

        L.marker([userLat, userLon]).addTo(map)
          .bindPopup('ä½ çš„ä½ç½®').openPopup();

        const stationLat = nearest.StationLatitude;
        const stationLon = nearest.StationLongitude;

        L.marker([stationLat, stationLon]).addTo(map)
          .bindPopup(`<b>${nearest.StationName.Zh_tw}</b><br/>
          <a href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${stationLat},${stationLon}" target="_blank">ğŸ§­ å°èˆªåˆ°é€™è£¡</a>`)
          .openPopup();

        map.setView([stationLat, stationLon], 17);
      }, err => {
        alert("å®šä½å¤±æ•—ï¼š" + err.message);
      });
    }
  </script>
</body>
</html>
