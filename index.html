<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Ubike æœ€è¿‘ç«™é»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 12px;
    }
    button {
      font-size: 18px;
      padding: 10px 14px;
      margin: 6px 6px 6px 0;
    }
    #map {
      height: 300px;
      margin-top: 10px;
      border-radius: 12px;
    }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h2>Ubikeæœ€è¿‘ç«™é»</h2>

  <button onclick="find('rent')">ğŸš² æ‰¾å¯å€Ÿè»Š</button>
  <button onclick="find('return')">ğŸ…¿ï¸ æ‰¾å¯é‚„è»Š</button>

  <pre id="out">è«‹é»ä¸Šæ–¹æŒ‰éˆ•</pre>
  <div id="map"></div>

  <script>
    const API_BASE = "https://ubike-proxy.onrender.com";

    let map, userMarker, stationMarker;

    function log(msg) {
      document.getElementById('out').textContent = msg;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function initMap(lat, lon) {
      if (!map) {
        map = L.map('map').setView([lat, lon], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap'
        }).addTo(map);
      } else {
        map.setView([lat, lon], 16);
      }

      if (userMarker) userMarker.remove();
      userMarker = L.marker([lat, lon]).addTo(map).bindPopup('ğŸ“ ä½ çš„ä½ç½®').openPopup();
    }

    async function find(mode) {
      try {
        log('ğŸ“ å–å¾—æ‰‹æ©Ÿå®šä½ä¸­â€¦');

        const pos = await new Promise((ok, err) =>
          navigator.geolocation.getCurrentPosition(ok, err, {
            enableHighAccuracy: true,
            timeout: 10000
          })
        );

        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        initMap(lat, lon);

        log('ğŸŒ å–å¾— Ubike è³‡æ–™ä¸­â€¦');

        const [stations, availability] = await Promise.all([
          fetch(API_BASE + '/bike/station', { cache: 'no-store' }).then(r => r.json()),
          fetch(API_BASE + '/bike/availability', { cache: 'no-store' }).then(r => r.json())
        ]);

        let best = null;
        let min = Infinity;

        availability.forEach(a => {
          if (mode === 'rent' && a.AvailableRentBikes === 0) return;
          if (mode === 'return' && a.AvailableReturnBikes === 0) return;

          const s = stations.find(st => st.StationUID === a.StationUID);
          if (!s) return;

          const d = haversine(
            lat, lon,
            s.StationPosition.PositionLat,
            s.StationPosition.PositionLon
          );

          if (d < min) {
            min = d;
            best = { s, a };
          }
        });

        if (!best) {
          log('âŒ é™„è¿‘æ²’æœ‰ç¬¦åˆçš„ç«™é»');
          return;
        }

        const sLat = best.s.StationPosition.PositionLat;
        const sLon = best.s.StationPosition.PositionLon;

        if (stationMarker) stationMarker.remove();
        stationMarker = L.marker([sLat, sLon])
          .addTo(map)
          .bindPopup('ğŸš² Ubike ç«™é»')
          .openPopup();

        map.fitBounds([
          [lat, lon],
          [sLat, sLon]
        ], { padding: [40, 40] });

        const navUrl =
          `https://www.google.com/maps/dir/?api=1` +
          `&destination=${sLat},${sLon}` +
          `&travelmode=walking`;

        log(
          `âœ… æ‰¾åˆ°æœ€è¿‘ç«™é»\n\n` +
          `ç«™åï¼š${best.s.StationName.Zh_tw}\n` +
          `è·é›¢ï¼šç´„ ${min.toFixed(0)} å…¬å°º\n\n` +
          `ğŸš² å¯å€Ÿè»Šï¼š${best.a.AvailableRentBikes}\n` +
          `ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š${best.a.AvailableReturnBikes}\n\n` +
          `ğŸ‘‰ é»åœ°åœ–å¯å°èˆª`
        );

        stationMarker.on('click', () => {
          window.open(navUrl, '_blank');
        });

      } catch (e) {
        log(
          'âŒ ç™¼ç”ŸéŒ¯èª¤\n' +
          'éŒ¯èª¤åç¨±ï¼š' + e.name + '\n' +
          'éŒ¯èª¤è¨Šæ¯ï¼š' + e.message
        );
      }
    }
  </script>

</body>
</html>
