<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Ubike æœ€è¿‘ç«™é»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont; padding: 16px; }
    button { font-size: 18px; padding: 10px 14px; margin: 6px 6px 6px 0; }
    pre { background: #f5f5f5; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>ğŸš² Ubike æœ€è¿‘ç«™é»ï¼ˆé«˜é›„ï¼‰</h2>

  <button onclick="find('rent')">ğŸš² æ‰¾å¯å€Ÿè»Š</button>
  <button onclick="find('return')">ğŸ…¿ï¸ æ‰¾å¯é‚„è»Š</button>

  <pre id="out">è«‹é»ä¸Šæ–¹æŒ‰éˆ•</pre>

  <script>
    const API_BASE = "https://ubike-proxy.onrender.com";

    function log(msg) {
      document.getElementById('out').textContent = msg;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function find(mode) {
      try {
        log('ğŸ“ å–å¾—æ‰‹æ©Ÿå®šä½ä¸­â€¦');

        const pos = await new Promise((ok, err) =>
          navigator.geolocation.getCurrentPosition(ok, err, {
            enableHighAccuracy: true,
            timeout: 10000
          })
        );

        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        log('ğŸŒ å–å¾— Ubike è³‡æ–™ä¸­â€¦');

        const [stations, availability] = await Promise.all([
          fetch(API_BASE + '/bike/station', { cache: 'no-store' }).then(r => r.json()),
          fetch(API_BASE + '/bike/availability', { cache: 'no-store' }).then(r => r.json())
        ]);

        let best = null;
        let min = Infinity;

        availability.forEach(a => {
          if (mode === 'rent' && a.AvailableRentBikes === 0) return;
          if (mode === 'return' && a.AvailableReturnBikes === 0) return;

          const s = stations.find(st => st.StationUID === a.StationUID);
          if (!s) return;

          const d = haversine(
            lat, lon,
            s.StationPosition.PositionLat,
            s.StationPosition.PositionLon
          );

          if (d < min) {
            min = d;
            best = { s, a };
          }
        });

        if (!best) {
          log('âŒ é™„è¿‘æ²’æœ‰ç¬¦åˆçš„ç«™é»');
          return;
        }

        log(
          `âœ… æ‰¾åˆ°æœ€è¿‘ç«™é»\n\n` +
          `ç«™åï¼š${best.s.StationName.Zh_tw}\n` +
          `è·é›¢ï¼šç´„ ${min.toFixed(0)} å…¬å°º\n\n` +
          `ğŸš² å¯å€Ÿè»Šï¼š${best.a.AvailableRentBikes}\n` +
          `ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š${best.a.AvailableReturnBikes}`
        );

      } catch (e) {
        log(
          'âŒ ç™¼ç”ŸéŒ¯èª¤\n' +
          'éŒ¯èª¤åç¨±ï¼š' + e.name + '\n' +
          'éŒ¯èª¤è¨Šæ¯ï¼š' + e.message
        );
      }
    }
  </script>
</body>
</html>
