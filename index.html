<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æœ€è¿‘ Ubikeï¼ˆé«˜é›„ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 12px; }
    button { padding: 12px 18px; font-size: 16px; }
    #status { margin-top: 8px; color: #555; }
    #map { height: 60vh; margin-top: 10px; border-radius: 12px; }
    pre { background:#f5f5f5; padding:8px; border-radius:8px; }
  </style>
</head>
<body>
  <h2>ğŸš² æœ€è¿‘çš„ Ubikeï¼ˆé«˜é›„ï¼‰</h2>
  <button onclick="start()">ğŸ“ ä½¿ç”¨æ‰‹æ©Ÿå®šä½</button>
  <div id="status"></div>
  <pre id="result"></pre>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Kaohsiung?$top=100&$format=JSON";
    let map, userMarker, stationMarker;

    function setStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function start() {
      setStatus('ğŸ“¡ å®šä½ä¸­â€¦');

      navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        setStatus('ğŸ” å°‹æ‰¾æœ€è¿‘ Ubikeâ€¦');
        const res = await fetch(API_URL);
        const data = await res.json();

        let nearest = null;
        let minDist = Infinity;

        data.forEach(s => {
          if (s.AvailableRentBikes === 0) return;
          const d = haversine(userLat, userLon, s.StationLatitude, s.StationLongitude);
          if (d < minDist) {
            minDist = d;
            nearest = s;
          }
        });

        document.getElementById('result').textContent =
          `æœ€è¿‘ç«™é»ï¼š${nearest.StationName.Zh_tw}\n` +
          `è·é›¢ï¼šç´„ ${minDist.toFixed(0)} å…¬å°º\n` +
          `å¯å€Ÿè»Šï¼š${nearest.AvailableRentBikes}`;

        if (!map) {
          map = L.map('map').setView([userLat, userLon], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
          }).addTo(map);
        }

        if (userMarker) userMarker.remove();
        if (stationMarker) stationMarker.remove();

        userMarker = L.marker([userLat, userLon]).addTo(map).bindPopup('ä½ çš„ä½ç½®');
        stationMarker = L.marker([nearest.StationLatitude, nearest.StationLongitude])
          .addTo(map)
          .bindPopup(`<b>${nearest.StationName.Zh_tw}</b><br/>
          <a href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${nearest.StationLatitude},${nearest.StationLongitude}" target="_blank">ğŸ§­ å°èˆªåˆ°é€™è£¡</a>`)
          .openPopup();

        map.setView([nearest.StationLatitude, nearest.StationLongitude], 17);
        setStatus('âœ… å®Œæˆ');
      }, err => {
        setStatus('âŒ å®šä½å¤±æ•—ï¼š' + err.message);
      }, {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      });
    }
  </script>
</body>
</html>
